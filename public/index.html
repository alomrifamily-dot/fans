<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Fans Wallet</title>
  <style>
    body { font-family: Tahoma, Arial, sans-serif; text-align: center; margin: 24px; background: #f4f6f9; }
    h1 { color: #2c3e50; margin-bottom: 8px; }
    .bar { display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; margin: 10px 0 22px; }
    input, button {
      padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;
    }
    button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
    button.secondary { background:#111827; }
    .card {
      margin: 0 auto; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px;
      width: min(420px, 92%); background: #fff; box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }
    .points { color: #16a34a; font-size: 20px; }
    .money  { color: #2563eb; font-size: 20px; }
    .updated { font-size: 12px; color: #6b7280; margin-top: 10px; }
    .muted { color:#6b7280; font-size:13px; }
    /* Toast */
    #toast {
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; background: #111827; color: #fff;
      padding: 12px 16px; border-radius: 8px; font-size: 15px; box-shadow: 0 10px 20px rgba(0,0,0,.15);
      opacity: 0; pointer-events: none; transition: opacity .25s ease, transform .25s ease; z-index: 9999;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(-6px); }
  </style>
</head>
<body>
  <h1>ğŸ’³ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø´Ø¬Ø¹ - Fans ğŸš€</h1>
  <p class="muted">Ø§Ù„Ø®Ø¯Ù…Ø© ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Render</p>

  <div class="bar">
    <label for="fanInput">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (fanId):</label>
    <input id="fanInput" type="text" placeholder="Ù…Ø«Ø§Ù„: fan_123" />
    <button id="applyFan">ØªØ·Ø¨ÙŠÙ‚</button>
    <button id="claimBtn" class="secondary" title="Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·: ÙŠØ·Ù„Ø¨ 50 Ù†Ù‚Ø·Ø©">+ Ù†Ù‚Ø§Ø· Ø§Ø®ØªØ¨Ø§Ø±</button>
  </div>

  <div id="wallet" class="card">
    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©...</p>
  </div>

  <div id="toast"></div>

  <script>
    // ==== Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====
    const walletBox = document.getElementById("wallet");
    const toastEl   = document.getElementById("toast");
    const fanInput  = document.getElementById("fanInput");
    const applyFan  = document.getElementById("applyFan");
    const claimBtn  = document.getElementById("claimBtn");

    // Ù‚Ø±Ø§Ø¡Ø© / ÙƒØªØ§Ø¨Ø© Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù†/Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
    function getFanIdFromURL() {
      const params = new URLSearchParams(location.search);
      return params.get("fan") || "fan_123";
    }
    function setFanIdInURL(fanId) {
      const url = new URL(location.href);
      url.searchParams.set("fan", fanId);
      history.replaceState({}, "", url.toString());
    }

    let fanId = getFanIdFromURL();
    fanInput.value = fanId;

    // Toast & Notification
    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 3500);
    }
    function notify(msg) {
      if ("Notification" in window && Notification.permission === "granted") {
        try { new Notification("Ù…Ø­ÙØ¸Ø© Fans", { body: msg }); } catch (_) { showToast(msg); }
      } else {
        showToast(msg);
      }
    }
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission().catch(()=>{});
    }

    // ==== Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø­ÙØ¸Ø© ====
    let prevPoints = null, prevMoney = null, firstLoad = true, timer = null;

    async function loadWallet() {
      try {
        const res  = await fetch(`/api/wallet/${encodeURIComponent(fanId)}`, { cache: "no-store" });
        const data = await res.json();

        const points = data?.wallet?.points ?? 0;
        const money  = data?.wallet?.money ?? 0;

        walletBox.innerHTML = `
          <h3>ğŸ“Œ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <code>${fanId}</code></h3>
          <p class="points">Ø§Ù„Ù†Ù‚Ø§Ø·: ${points}</p>
          <p class="money">Ø§Ù„Ø±ØµÙŠØ¯: ${money} Ø±ÙŠØ§Ù„</p>
          <p class="updated">â± Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString()}</p>
        `;

        if (!firstLoad) {
          if (prevPoints !== null && points > prevPoints) {
            notify(`ğŸ‰ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${points - prevPoints} Ù†Ù‚Ø·Ø©!`);
          }
          if (prevMoney !== null && money > prevMoney) {
            notify(`ğŸ’° Ø²Ø§Ø¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù…Ù‚Ø¯Ø§Ø± ${money - prevMoney} Ø±ÙŠØ§Ù„!`);
          }
        }
        prevPoints = points; prevMoney = money; firstLoad = false;

      } catch (err) {
        walletBox.innerHTML = "<p style='color:red'>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âŒ</p>";
        console.error("Error loading wallet:", err);
      }
    }

    function startAutoRefresh() {
      if (timer) clearInterval(timer);
      timer = setInterval(loadWallet, 10000);
    }

    // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    applyFan.addEventListener("click", () => {
      const newId = (fanInput.value || "").trim();
      if (!newId) return showToast("Ø§ÙƒØªØ¨ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹");
      if (newId === fanId) return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù");
      fanId = newId;
      setFanIdInURL(fanId);
      showToast(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰: ${fanId}`);
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØµØ¯Ø± ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
      prevPoints = prevMoney = null; firstLoad = true;
      loadWallet();
    });

    // Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± (ÙŠØ·Ù„Ø¨ 50 Ù†Ù‚Ø·Ø© Ù„Ù„Ù€ fan Ø§Ù„Ø­Ø§Ù„ÙŠ)
    claimBtn.addEventListener("click", async () => {
      try {
        const res = await fetch("/api/wallet/award", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fanId, currency: "POINTS", amount: 50, reason: "Test award (UI)" })
        });
        const data = await res.json();
        if (data?.ok) {
          notify("âœ… ØªÙ… Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© 50 Ù†Ù‚Ø·Ø© (Ø§Ø®ØªØ¨Ø§Ø±).");
          loadWallet();
        } else {
          showToast("âŒ ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.");
        }
      } catch (e) {
        showToast("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨.");
      }
    });

    // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    loadWallet();
    startAutoRefresh();
  </script>
</body>
</html>
